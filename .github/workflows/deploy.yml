---
"on":
  push:
    branches:
      - main

name: Deploy

concurrency:
  group: terraform-deploy
  cancel-in-progress: false

env:
  # renovate: datasource=github-releases packageName=opentofu/opentofu
  OPENTOFU_VERSION: 1.9.1
  # renovate: datasource=github-releases packageName=gruntwork-io/terragrunt
  TERRAGRUNT_VERSION: 0.81.8
  WORKING_DIRECTORY: terraform

jobs:
  apply:
    name: Apply
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: taiki-e/install-action@just

      - name: Install OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.OPENTOFU_VERSION }}

      - name: Install Terragrunt
        run: |
          wget -qO /tmp/terragrunt https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          sudo install -m 755 /tmp/terragrunt /usr/local/bin/terragrunt

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ASSUME_ROLE_ARN }}
          role-session-name: ${{ github.event_name }}-${{ github.run_id }}-${{ github.job }}
          aws-region: ca-central-1

      - name: Apply
        run: just terraform/apply
